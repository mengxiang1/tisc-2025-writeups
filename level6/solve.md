# Level 6 `Passkey`

**Flag:** `TISC{p4ssk3y_is_gr3a7_t|sC}`

## TL;DR

- When attempting to log in, the app asks the browser to call `navigator.credentials.get()` with an `allowCredentials` list containing the user's credential ID that you are trying to log in as.
- The server, however, accepts any valid WebAuthn assertion for that login attempt and does not verify that the assertion actually came from the credential bound to the correct account.
- We can register a dummy user, attempt to log in as admin, but replace the credential ID passed to  `navigator.credentials.get()`. The browser prompts for the passkey of the dummy user, producing an assertion for the dummy user, which the server does not validate, giving us an admin session.

---

## Challenge summary

- The server allows us to register users and log in using passkeys via tha WebAuthn API.
- The goal is to log in as `admin`, which then gives us the flag.

---

## Vulnerability

Since no source is provided for this challenge, I had to blindly test for vulnerabilities. Eventually, I found a vulnerability in the login flow:

- Visiting `/auth/login` and attempting to log in as admin triggers the following JS:

```js
navigator.credentials.get({
  publicKey: {
    challenge: base64UrlToBuffer("..."),
    rpId: "passkey.chals.tisc25.ctf.sg",
    allowCredentials: [
      { id: base64UrlToBuffer("DUvFhC3oiS3G8aO61d5hUMAehmI"), type: "public-key" }
    ],
    userVerification: "preferred",
  }
});
```

- The `allowCredentials` entry is the admin credential ID: `DUvFhC3oiS3G8aO61d5hUMAehmI`
- The credential ID is purely for the browser to identify which user to log in as. If the credential ID is changed, the browser can prompt for the passkey of a different user.
- As part of my blind testing, I attempted try the above. Using the JS debugger in DevTools I replaced the id passed to `navigator.credentials.get()` with one I generated by registering a dummy user.
- The browser prompted the passkey prompt for my dummy key, produced an assertion and submitted the login attempt.
- Instead of rejecting the assertion, the server accepted it and granted admin access, giving me access to the flag.

In conclusion, the server did not in fact validate the public key from the assertion and only validated the assertion based on the `challenge` and `rpId`, allowing me to log in to any user with another user's passkey.